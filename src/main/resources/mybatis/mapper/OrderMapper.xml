<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spingboot.express.mapper.OrderMapper">
<resultMap id="BaseResultMap" type="spingboot.express.pojo.OrderInfo">
    <id column="id" jdbcType="INTEGER" property="ID"/>
    <result column="tel" jdbcType="VARCHAR" property="tel"/>
    <result column="ship_address" jdbcType="VARCHAR" property="shipAddress"/>
    <result column="send_address" jdbcType="VARCHAR" property="sendAddress"/>
    <result column="money" jdbcType="VARCHAR" property="money"/>
    <result column="sex" jdbcType="VARCHAR" property="sex"/>
    <result column="size" jdbcType="VARCHAR" property="size"/>
    <result column="note" jdbcType="VARCHAR" property="note"/>
    <result column="dead_line" jdbcType="TIMESTAMP" property="deadLine"/>
    <result column="receiver_id" jdbcType="VARCHAR" property="receiverID"/>
    <result column="sender_id" jdbcType="VARCHAR" property="senderID"/>
    <result column="receive_tel" jdbcType="VARCHAR" property="receiveTel"/>
    <result column="order_status" jdbcType="INTEGER" property="orderStatus"/>
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
    <result column="is_valid" jdbcType="VARCHAR" property="isValid"/>
    <result column="receive_time" jdbcType="TIMESTAMP" property="receiveTime"/>
    <result column="version" jdbcType="INTEGER" property="version"/>
</resultMap>

<resultMap id="BaseResultMap2" type="spingboot.express.dto.ReceiveOrderDto">
<!--  column中的值代表数据库中的字段，property代表类中对应的字段  -->
    <id column="id" jdbcType="INTEGER" property="ID"/>
    <result column="receiver_id" jdbcType="VARCHAR" property="receiverID"/>
    <result column="receive_tel" jdbcType="VARCHAR" property="receiveTel"/>
    <result column="order_status" jdbcType="INTEGER" property="orderStatus"/>
</resultMap>
    <sql id="Base_Order_Info">
       id,tel,ship_address,send_address,money,sex,size,note,dead_line,receiver_id,sender_id,
       receive_tel,order_status,create_time,is_valid,receive_time,version
    </sql>

    <!--发单人发送快递信息-->
    <!--  允许JDBC自动生成主键，并返回  -->
    <insert id="add" parameterType="spingboot.express.pojo.OrderInfo" keyProperty="ID" useGeneratedKeys="true">
        insert into orderInfo
        <trim prefix="(" suffix=")" suffixOverrides=",">
              <if test="tel != null">
                  tel,
              </if>
              <if test="shipAddress != null">
                  ship_address,
              </if>
              <if test="sendAddress != null">
                  send_address,
              </if>
              <if test="money != null">
                  money,
              </if>
              <if test="sex != null">
                  sex,
              </if>
              <if test="size != null">
                  size,
              </if>
              <if test="note != null">
                  note,
              </if>
              <if test="deadLine != null">
                  dead_line,
              </if>
              <if test="senderID != null">
                  sender_id,
              </if>
              <if test="createTime == null">
                  create_time,
              </if>
              <if test="receiveTel != null">
                  receive_tel,
              </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="tel != null">
                #{tel,jdbcType=VARCHAR},
            </if>
            <if test="shipAddress != null">
                #{shipAddress,jdbcType=VARCHAR},
            </if>
            <if test="sendAddress != null">
                #{sendAddress,jdbcType=VARCHAR},
            </if>
            <if test="money != null">
                #{money,jdbcType=VARCHAR},
            </if>
            <if test="sex != null">
                #{sex,jdbcType=VARCHAR},
            </if>
            <if test="size != null">
                #{size,jdbcType=VARCHAR},
            </if>
            <if test="note != null">
                #{note,jdbcType=VARCHAR},
            </if>
            <if test="deadLine != null">
                #{deadLine,jdbcType=TIMESTAMP},
            </if>
            <if test="senderID != null">
                #{senderID,jdbcType=VARCHAR},
            </if>
            <if test="createTime == null">
                now(),
            </if>
            <if test="receiveTel != null">
                #{receiveTel,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <!--接单人编辑订单-->
<!--    <update id="receiverEditInfo" parameterType="spingboot.express.pojo.OrderInfo">-->
<!--        update orderInfo set receiver_telephone = #{receiver_telephone} where id = #{id}-->
<!--    </update>-->

    <!--  发单用户编辑订单  -->
    <update id="senderEditInfo" parameterType="spingboot.express.dto.WriteInfoDto">
        update orderInfo
        <set>
            <if test="tel != null">
                tel = #{tel,jdbcType=VARCHAR},
            </if>
            <if test="shipAddress != null">
                ship_address = #{shipAddress,jdbcType=VARCHA},
            </if>
            <if test="sendAddress != null">
                send_address = #{sendAddress,jdbcType=VARCHA},
            </if>
            <if test="money != null">
                money = #{money,jdbcType=VARCHA},
            </if>
            <if test="sex != null">
                sex = #{sex,jdbcType=VARCHA},
            </if>
            <if test="note != null">
                note = #{note,jdbcType=VARCHA},
            </if>
            <if test="deadLine != null">
                deaf_line = #{deadLine,jdbcType=TIMESTAMP},
            </if>
            <if test="size != null">
                size = #{size,jdbcType=VARCHA},
            </if>
        </set>
        where id = #{ID}
    </update>
    <!--查询单个订单详细信息-->
    <select id="querySingleInfoOrder" parameterType="int" resultType="spingboot.express.pojo.OrderInfo">
        select
        <include refid="Base_Order_Info"/>
        from orderInfo
        where id = #{ID}
    </select>
    <!--查询所有信息的截止时间，来判断订单是否过期-->
    <select id="findAll" resultMap="BaseResultMap">
        select
        id,dead_line
        from orderInfo
    </select>

     <!--查询所有有效信息-->
    <select id="findAllValid" resultMap="BaseResultMap">
        select
        <include refid="Base_Order_Info"/>
        from orderInfo
        where
        is_valid = 1
    </select>

    <!--查询所有发单信息-->
    <select id="findSenderInfo" parameterType="String" resultMap="BaseResultMap">
        select
        <include refid="Base_Order_Info"/>
        from orderInfo
        where sender_id = #{sendUserID}
    </select>

    <!--查询所有接单信息-->
    <select id="findReceivedInfo" parameterType="String" resultMap="BaseResultMap">
        select
        <include refid="Base_Order_Info"/>
        from orderInfo
        where receiver_id = #{receiverID}
    </select>
    <!--发单人取消发单-->
    <delete id="deleteInfo" parameterType="int">
        delete
        from orderInfo
        where id = #{ID}
    </delete>
    <!--订单过期，置为无效-->
    <update id="updateOrderStatusById" parameterType="int">
      update
      orderInfo
      set
      is_valid = 0
      where
      id = #{id}
    </update>
    <!--使新插入数据库的数据从最大数字+1开始-->
    <update id="alterInfo" parameterType="int">
        alter table orderInfo auto_increment = #{i}
    </update>
    <!--删除数据后，使id连续-->
    <update id="update" parameterType="spingboot.express.pojo.OrderInfo">
        update orderInfo set id = id-1 where id > #{id}
    </update>
    <!--检查订单是否被其他人接单信息-->
    <select id="checkIfReceived" parameterType="int" resultType="String">
        select
        receiver_id
        from orderInfo
        where id=#{ID}
    </select>
    <!--  根据订单ID检查订单状态  -->
    <select id="checkStatusById" parameterType="int" resultType="int">
        select order_status
        from orderInfo
        where id = #{ID}
    </select>
    <!--根据订单ID检查订单的所有信息-->
    <select id="checkInfoById" parameterType="int" resultMap="BaseResultMap">
        select *
        from orderInfo
        where id = #{ID}
    </select>
    <!--接单用户取消接单，删除接单用户信息-->
    <update id="deleteReceiver" parameterType="int">
        update orderInfo set receiver_id = null,receive_tel = null,receive_time = null where id = #{ID}
    </update>
    <!--  发单人删除发单信息，更新订单中发单人信息  -->
    <update id="deleteSenderInOrder" parameterType="int">
        update orderInfo
        set
        sender_id = null,tel = null
        where
        id = #{ID}
    </update>
    <!--接单人接单,在信息中插入接单人信息-->
    <update id="userOrder" parameterType="spingboot.express.dto.ReceiveOrderDto">
        update orderInfo
        <set>
            <if test="receiveTel != null">
                receive_tel =  #{receiveTel,jdbcType=VARCHAR},
            </if>
            <if test="receiverID != null">
                receiver_id = #{receiverID,jdbcType=VARCHAR},
            </if>
            <if test="receiveTime == null">
                receive_time = now(),
            </if>
            <if test="orderStatus != null">
                order_status = #{orderStatus,jdbcType=INTEGER},
            </if>

                version = version+1,

                is_valid = 0
        </set>
        where id = #{ID,jdbcType=INTEGER} and version = 1
    </update>

    <!--改变订单状态-->
    <update id="changeOrderStatus" parameterType="spingboot.express.pojo.OrderInfo">
        update orderInfo
        set order_status = #{orderStatus}
        where id = #{ID}
    </update>
    <!--改变订单为无效-->
    <update id="setToInvalid" parameterType="int">
        update orderInfo set is_valid = 0 where id = #{ID}
    </update>

    <!--  改变订单为无效  -->
    <update id="setToValid" parameterType="int">
        update orderInfo
        set
        is_valid = 1
        where
        id = #{ID}
    </update>
</mapper>